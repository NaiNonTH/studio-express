<%- contentFor('styleLink') %>
<link rel="stylesheet" href="/stylesheets/dashboard.css">

<%- contentFor('body') %>
<div class="dashboard">
  
  <div class="box span">
    <h2>สวัสดี <%=user.name %></h2>
    <a href="/logout" class="button">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-left" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0z"/>
        <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708z"/>
      </svg>
      ออกจากระบบ
    </a>
  </div>

  <div class="box reservation-list">
    <a class="button" href="/dashboard/reservation">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-plus-fill" viewBox="0 0 16 16">
        <path d="M4 .5a.5.5 0 0 0-1 0V1H2a2 2 0 0 0-2 2v1h16V3a2 2 0 0 0-2-2h-1V.5a.5.5 0 0 0-1 0V1H4zM16 14V5H0v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2M8.5 8.5V10H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V11H6a.5.5 0 0 1 0-1h1.5V8.5a.5.5 0 0 1 1 0"/>
      </svg>
      เพิ่มการจอง
    </a>

    <% 
      let futureReservations = [];
      if (typeof reservations !== 'undefined' && reservations.length > 0) {
        const now = new Date();
        futureReservations = reservations.filter(r => {
          const rDate = new Date(r.datetime);
          return rDate >= now; // กรองเอาเฉพาะอันที่ยังไม่ถึงเวลา
        });
        // เรียงลำดับ เวลาใกล้สุดขึ้นก่อน
        futureReservations.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
      }
    %>

    <% if (futureReservations.length === 0) { %>
      <div class="center">
        <p class="hero">ไม่มีคิวจอง</p>
        <p>กด <b>เพิ่มการจอง</b> เพื่อเริ่มจองได้เลย</p>
      </div>
    <% } else { %>
      <% futureReservations.forEach(function(r) { 
           const dateObj = new Date(r.datetime);
           const startHour = dateObj.getHours();
           const startMinute = dateObj.getMinutes();
           const startTimeStr = `${startHour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`;
           const endHour = startHour + 1;
           const endTimeStr = `${endHour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`;
      %>
      <div class="box">
        <div class="zone">
           <%= r.zone_name ? r.zone_name.charAt(0) : 'R' %> 
        </div>
        <div class="details">
          <h3>
            <%= dateObj.toLocaleDateString('th-TH', { weekday: 'short', year: 'numeric', month: 'long', day: 'numeric' }) %>
          </h3>
          <p>เวลา <%= startTimeStr %> น. - <%= endTimeStr %> น.</p>
        </div>
        <div class="actions">
          <a href="/dashboard/reservation/edit/<%= r.reservation_id %>" class="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-fill" viewBox="0 0 16 16">
                <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
              </svg>
              แก้ไข
          </a>
          <form method="GET" action="/dashboard/reservation/cancel-reservation/<%= r.reservation_id %>" 
                onsubmit="return confirm('⚠️ ยืนยันการยกเลิก?\n\nคุณแน่ใจหรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้');">
              <button type="submit" class="for-delete">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                    <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
                  </svg>
                  ยกเลิก
              </button>
          </form>
        </div>
      </div>
    <% }); %>
    <% } %>
  </div>

  <div class="account-settings">
    <form method="post" action="/dashboard/user/edit" class="box">
      <h2>รายละเอียดบัญชี</h2>
      <% if (target === "edit-user") { %>
        <ul class="error">
          <% for (const errorMessage of errorMessages) { %>
            <li><%=errorMessage %></li>
          <% } %>
        </ul>
        <% if (updated) { %>
         <p>อัพเดทข้อมูลสำเร็จ</p>
        <% } %>
      <% } %>
      <div>
        <label for="user_name">ชื่อ-สกุล</label>
        <input type="text" name="user_name" id="user_name" value="<%=user.name %>">
      </div>
      <div>
        <label for="email">อีเมล</label>
        <input type="text" name="email" id="email" value="<%=user.email %>">
      </div>
      <button>ส่งแก้ไขรายละเอียด</button>
    </form>
    <form method="post" action="/dashboard/user/edit-password" class="box">
      <h2>รหัสผ่านใหม่</h2>
      <% if (target === "edit-password") { %>
        <ul class="error">
          <% for (const errorMessage of errorMessages) { %>
            <li><%=errorMessage %></li>
          <% } %>
        </ul>
        <% if (updated) { %>
         <p>อัพเดทรหัสผ่านสำเร็จ</p>
        <% } %>
      <% } %>
      <div>
        <label for="current_password">รหัสผ่านปัจจุบัน</label>
        <input type="password" name="current_password" id="current_password">
      </div>
      <div>
        <label for="new_password">รหัสผ่านใหม่</label>
        <input type="password" name="new_password" id="new_password">
        <p class="note">รหัสผ่านต้องยาวตั้งแต่ 8 ตัวอักษรขึ้นไป</p>
      </div>
      <div>
        <label for="confirm_password">กรอกรหัสผ่านใหม่อีกครั้ง</label>
        <input type="password" name="confirm_password" id="confirm_password">
      </div>
      <button>ส่งแก้ไขรายละเอียด</button>
    </form>
    <form method="post" action="/dashboard/user/delete" onsubmit="return confirm('⚠️ ยืนยันการลบบัญชี?\n\nคุณแน่ใจหรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้');" class="box">
      <h2>ลบบัญชี</h2>
      <% if (target === "delete") { %>
        <ul class="error">
          <% for (const errorMessage of errorMessages) { %>
            <li><%=errorMessage %></li>
          <% } %>
        </ul>
      <% } %>
      <div>
        <label for="user_name">กรอกชื่อ-สกุลของคุณก่อนลบบัญชี</label>
        <input type="text" name="user_name" id="user_name">
      </div>
      <div>
        <label for="password">กรอกรหัสผ่าน</label>
        <input type="password" name="password" id="password">
      </div>
      <button>ลบบัญชี</button>
    </form>
  </div>
</div>
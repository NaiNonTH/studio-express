<%- contentFor('styleLink') %>
<link rel="stylesheet" href="/stylesheets/reservation.css">

<%- contentFor('body') %>

<div class="reservation-form box">
    <h1><%= (typeof booking !== 'undefined') ? 'แก้ไขการจอง' : 'การจองห้องใหม่' %></h1>

    <form method="POST" action="<%= (typeof booking !== 'undefined') ? '/dashboard/reservation/update/' + booking.reservation_id : '/dashboard/reservation/reservation-process' %>">
        
        <div>
            <label for="customer-name">ชื่อ-สกุล</label>
            <input type="text" id="customer-name" name="customer_name" readonly value="<%= user.name %>">
        </div>

        <div>
            <label for="reservation-date">วันที่จอง</label>
            <input type="date" id="reservation-date" name="reservation_date" required 
                   value="<%= (typeof booking !== 'undefined' && booking.datetime) ? booking.datetime.toString().split(' ')[0] : '' %>">
            <p class="note">ท่านสามารถจองได้ล่วงหน้าอย่างน้อย 2 วัน</p>
        </div>

        <div>
            <label>โซนที่ต้องการจอง</label>
            <div class="zone-grid" id="zone-container">
                <% if (typeof zones !== 'undefined' && zones.length > 0) { %>
                    <% zones.forEach(function(zone) { %>
                        <label class="zone-card">
                            <input type="radio" 
                                   name="reservation_zone" 
                                   value="<%= zone.zone_id %>" 
                                   required
                                   <%= (typeof booking !== 'undefined' && booking.zone_id === zone.zone_id) ? 'checked' : '' %>
                            >
                            <div class="zone-box">
                                <h3><%= zone.zone_name %></h3>
                                <p><%= zone.zone_details || 'ไม่มีรายละเอียดเพิ่มเติม' %></p>
                            </div>
                        </label>
                    <% }); %>
                <% } else { %>
                    <p>ไม่พบข้อมูลโซน</p>
                <% } %>
            </div>
            <p class="note" style="margin-top: 10px;">กรุณาคลิกเลือกโซนที่ต้องการ</p>
        </div>
        <div>
            <label for="reservation-time">เวลาจอง</label>
            <select id="reservation-time" name="reservation_time" required>
                <option value="" disabled selected>-- กรุณาเลือกเวลา --</option>
            </select>
            <p class="note">จองได้ครั้งละ 1 ชั่วโมง</p>
        </div>
        
        <button type="submit">ยืนยันการจอง</button>
    </form>
</div>

<script>
    const allReservations = <%- (typeof reservations !== 'undefined') ? JSON.stringify(reservations) : '[]' %>;
    const currentBooking = <%- (typeof booking !== 'undefined') ? JSON.stringify(booking) : 'null' %>;

    const dateInput = document.getElementById('reservation-date');
    const timeSelect = document.getElementById('reservation-time');
    
    // Select all radio inputs for zones
    const zoneRadios = document.querySelectorAll('input[name="reservation_zone"]');

    // --- Min Date Logic ---
    const today = new Date();
    today.setDate(today.getDate() + 2);
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const minDate = `${yyyy}-${mm}-${dd}`;
    
    dateInput.min = minDate;
    
    if (!currentBooking && !dateInput.value) {
        dateInput.value = minDate;
    }

    // --- Helper function to get selected zone value ---
    function getSelectedZoneValue() {
        const checkedRadio = document.querySelector('input[name="reservation_zone"]:checked');
        return checkedRadio ? checkedRadio.value : null;
    }

    // --- Core Logic ---
    function updateAvailableTimes() {
        const selectedDate = dateInput.value;
        const selectedZone = getSelectedZoneValue(); // Changed from .value to helper function
        
        timeSelect.innerHTML = '<option value="" disabled selected>-- กรุณาเลือกเวลา --</option>';

        if (!selectedZone) {
            // If no zone selected yet, don't generate times or show "Select Zone first"
            return; 
        }

        for (let i = 0; i < 24; i++) {
            const hour = i.toString().padStart(2, '0');
            const timeValue = `${hour}:00`;
            
            const option = document.createElement('option');
            option.value = timeValue;
            option.textContent = `${hour}:00 - ${hour}:59`;

            let isTaken = false;
            
            if (selectedDate && selectedZone) {
                isTaken = allReservations.some(r => {
                    if (currentBooking && r.reservation_id == currentBooking.reservation_id) {
                        return false; 
                    }
                    const rDateTime = r.datetime.toString().replace('T', ' ').substring(0, 16); 
                    const checkDateTime = `${selectedDate} ${timeValue}`;
                    
                    return r.zone_id == selectedZone && rDateTime === checkDateTime;
                });
            }

            if (isTaken) {
                option.disabled = true;
                option.textContent += " (ไม่ว่าง)";
                option.style.color = "red";
            }

            if (currentBooking) {
                const oldTime = currentBooking.datetime.toString().split(' ')[1].substring(0, 5);
                const oldDate = currentBooking.datetime.toString().split(' ')[0];

                if (timeValue === oldTime && selectedDate === oldDate) {
                    option.selected = true;
                    option.disabled = false;
                    option.textContent = option.textContent.replace(' (ไม่ว่าง)', '');
                    option.style.color = '';
                }
            }

            timeSelect.appendChild(option);
        }
    }

    // --- Event Listeners ---
    dateInput.addEventListener('change', updateAvailableTimes);
    
    // Add event listener to ALL radio buttons
    zoneRadios.forEach(radio => {
        radio.addEventListener('change', updateAvailableTimes);
    });

    // Run on load
    updateAvailableTimes();
</script>
<%- contentFor('body') %>
<div class="reservation-form">
    <h1>การจองห้องใหม่</h1>
    <form method="POST" action="/dashboard/reservation/reservation-process">
        <div>
            <label for="customer-name">ชื่อ-สกุล</label>
            <input type="text" id="customer-name" name="customer_name" readonly value="<%= user.name %>">
        </div>
        <div>
            <label for="reservation-date">วันที่จอง</label>
            <input type="date" id="reservation-date" name="reservation_date" required>
            <p class="note">ท่านสามารถจองได้ล่วงหน้าอย่างน้อย 2 วัน</p>
        </div>
        <div>
            <label for="reservation-zone">โซนที่ต้องการจอง</label>
            <select id="reservation-zone" name="reservation_zone" required class="modern-select">
                <option value="" disabled selected>-- กรุณาเลือกโซน --</option>

                <% if (typeof zones !== 'undefined' && zones.length > 0) { %>
                    <% zones.forEach(function(zone) { %>
                        <option value="<%= zone.zone_id %>">
                            <%= zone.zone_name %>
                        </option>
                    <% }); %>
                <% } else { %>
                    <option value="" disabled>ไม่พบข้อมูลโซน</option>
                <% } %>
            </select>
            <p class="note">ระบบจะแสดงเฉพาะโซนที่เปิดให้บริการเท่านั้น</p>
        </div>
        <div>
            <label for="reservation-time">เวลาจอง</label>
            <select id="reservation-time" name="reservation_time" required>
                <option value="" disabled selected>-- กรุณาเลือกเวลา --</option>
                </select>
            <p class="note">จองได้ครั้งละ 1 ชั่วโมง</p>
        </div>
        
        <button type="submit">ยืนยันการจอง</button>
    </form>
</div>

<script>
    // 1. รับข้อมูลการจองจาก Server มาเก็บไว้ในตัวแปร JS
    // JSON.stringify จะแปลงข้อมูล Database เป็น Text เพื่อให้ JS อ่านได้
    const existingReservations = <%- JSON.stringify(reservations) %>;

    const dateInput = document.getElementById('reservation-date');
    const zoneSelect = document.getElementById('reservation-zone');
    const timeSelect = document.getElementById('reservation-time');
    
    // --- ส่วนตั้งค่าวันเริ่มต้น (เหมือนเดิม) ---
    const today = new Date();
    today.setDate(today.getDate() + 2);
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const minDate = `${yyyy}-${mm}-${dd}`;
    
    dateInput.min = minDate;
    dateInput.value = minDate; // เลือกวันแรกให้เลย

    // --- ฟังก์ชันสร้างตัวเลือกเวลา (Core Logic) ---
    function updateAvailableTimes() {
        const selectedDate = dateInput.value; // วันที่ที่ user เลือก (YYYY-MM-DD)
        const selectedZone = zoneSelect.value; // โซนที่ user เลือก (ID)

        // เคลียร์ Option เวลาเก่าทิ้งก่อน
        timeSelect.innerHTML = '<option value="" disabled selected>-- กรุณาเลือกเวลา --</option>';

        // วนลูปสร้างเวลา 00:00 - 23:00
        for (let i = 0; i < 24; i++) {
            const hour = i.toString().padStart(2, '0');
            const timeValue = `${hour}:00`; // ค่าที่จะเช็ค เช่น "11:00"

            // สร้าง Element Option เตรียมไว้
            const option = document.createElement('option');
            option.value = timeValue;
            option.textContent = `${hour}:00 - ${hour}:59`;

            // --- เช็คว่าเวลานี้ โดนจองไปหรือยัง? ---
            // ถ้ายังไม่ได้เลือกโซน หรือ เลือกวัน ก็ให้ปล่อยว่างไปก่อน
            if (selectedDate && selectedZone) {
                
                // ค้นหาใน existingReservations ว่ามีอันไหนชนไหม
                const isTaken = existingReservations.some(booking => {
                    // แปลงวันที่จาก DB เป็น Object Date
                    const bookingDateObj = new Date(booking.datetime);
                    
                    // แปลงเป็นวันที่ YYYY-MM-DD (ใช้ en-CA จะได้ format เรียงปีเดือนวันพอดี)
                    const bookingDateStr = bookingDateObj.toLocaleDateString('en-CA');
                    
                    // ดึงเฉพาะเวลา HH:MM ออกมา (ตัด :00 วินาทีทิ้ง)
                    const bookingTimeStr = bookingDateObj.toTimeString().substring(0, 5);

                    // เงื่อนไข: วันตรง && โซนตรง && เวลาตรง
                    return bookingDateStr === selectedDate && 
                           booking.zone_id == selectedZone && 
                           bookingTimeStr === timeValue;
                });

                if (isTaken) {
                    option.disabled = true; // กดไม่ได้
                    option.textContent += " (ไม่ว่าง)"; // เพิ่มข้อความบอก
                    option.style.color = "red"; // ตัวแดง
                }
            }

            timeSelect.appendChild(option);
        }
    }

    // --- สั่งให้ทำงานเมื่อมีการเปลี่ยนค่า ---
    // เมื่อเปลี่ยนวันที่ -> คำนวณเวลาใหม่
    dateInput.addEventListener('change', updateAvailableTimes);
    // เมื่อเปลี่ยนโซน -> คำนวณเวลาใหม่
    zoneSelect.addEventListener('change', updateAvailableTimes);

    // รันครั้งแรกตอนโหลดหน้าเว็บทันที
    updateAvailableTimes();

</script>